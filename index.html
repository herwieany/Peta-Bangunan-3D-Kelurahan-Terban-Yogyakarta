<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Bangunan Kelurahan Terban, Yogyakarta</title>
    <!-- CesiumJS CSS dan JS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            overflow: hidden;
            background-color: #0a1f2d;
            color: #f0f0f0;
        }
        
        #header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(10, 31, 45, 0.9);
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid #2a9fd6;
        }
        
        #title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
        }
        
        #title span {
            color: #2a9fd6;
        }
        
        #controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-label {
            font-size: 0.85rem;
            color: #a0c8e0;
            font-weight: 600;
        }
        
        .btn {
            background-color: #1a3b4d;
            color: #ffffff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #2a9fd6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn.active {
            background-color: #2a9fd6;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
        }
        
        .btn i {
            font-size: 1.1rem;
        }
        
        #cesiumContainer {
            position: absolute;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(10, 31, 45, 0.85);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-left: 4px solid #2a9fd6;
        }
        
        #instructions h3 {
            margin-bottom: 10px;
            color: #2a9fd6;
            font-size: 1.2rem;
        }
        
        #instructions ul {
            margin-left: 15px;
            color: #d0e6f7;
            font-size: 0.9rem;
        }
        
        #instructions li {
            margin-bottom: 8px;
        }
        
        #status {
            position: absolute;
            top: 100px;
            right: 20px;
            background-color: rgba(10, 31, 45, 0.85);
            border-radius: 8px;
            padding: 12px 15px;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-left: 4px solid #4caf50;
            font-size: 0.9rem;
            max-width: 250px;
        }
        
        #status h3 {
            color: #4caf50;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        .mode-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .day-mode {
            background-color: #ffcc00;
            box-shadow: 0 0 8px #ffcc00;
        }
        
        .night-mode {
            background-color: #2a9fd6;
            box-shadow: 0 0 8px #2a9fd6;
        }
        
        .cesium-widget-credits {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            #header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            #title {
                font-size: 1.4rem;
            }
            
            #controls {
                width: 100%;
                justify-content: space-between;
            }
            
            #instructions, #status {
                max-width: 200px;
                font-size: 0.8rem;
            }
            
            #cesiumContainer {
                top: 120px;
            }
        }
    </style>
    <!-- Ikon FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="header">
        <div id="title">
            <i class="fas fa-map-marked-alt"></i> Peta <span>Bangunan Kelurahan Terban, Yogyakarta</span>
        </div>
        <div id="controls">
            <div class="control-group">
                <div class="control-label">TAMPILAN PETA</div>
                <div>
                    <button id="toggle3D" class="btn active"><i class="fas fa-globe-americas"></i> 3D</button>
                    <button id="toggle2D" class="btn"><i class="fas fa-map"></i> 2D</button>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">WAKTU</div>
                <div>
                    <button id="dayMode" class="btn active"><i class="fas fa-sun"></i> Siang</button>
                    <button id="nightMode" class="btn"><i class="fas fa-moon"></i> Malam</button>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">ALAT UKUR</div>
                <div>
                    <button id="measureLength" class="btn"><i class="fas fa-ruler"></i> Panjang</button>
                    <button id="measureArea" class="btn"><i class="fas fa-vector-square"></i> Luas</button>
                </div>
            </div>
            <button id="resetView" class="btn"><i class="fas fa-home"></i> Reset View</button>
        </div>
    </div>
    
    <div id="cesiumContainer"></div>
    
    <div id="instructions">
        <h3><i class="fas fa-info-circle"></i> Petunjuk Penggunaan</h3>
        <ul>
            <li>Gunakan mouse untuk menggeser, zoom, dan rotasi peta</li>
            <li>Klik tombol <strong>Panjang</strong> untuk mengukur jarak</li>
            <li>Klik tombol <strong>Luas</strong> untuk mengukur area</li>
            <li>Tombol <strong>Siang/Malam</strong> mengubah waktu tampilan</li>
            <li>Tombol <strong>Reset View</strong> kembali ke lokasi awal</li>
        </ul>
    </div>
    
    <div id="status">
        <h3><i class="fas fa-map-pin"></i> Status Peta</h3>
        <div><span class="mode-indicator day-mode"></span> Mode: <span id="viewMode">3D</span></div>
        <div><span class="mode-indicator day-mode"></span> Waktu: <span id="timeMode">Siang</span></div>
        <div><i class="fas fa-ruler-combined"></i> Alat Ukur: <span id="measureMode">Tidak Aktif</span></div>
    </div>

    <script>
        // Cesium Ion Token - Gunakan token default untuk akses ke data Cesium World Terrain dan Bing Maps
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYWE1OWUxNy1mMWZiLTQzYjYtYTQ0OS1kMWFjYmFkNjYyZTciLCJpZCI6MjAwMzA1LCJpYXQiOjE3MTE4MTI0OTR9.8C5t_9JxXI8Uzwt-JgOaYfXJNfKf5oDPn-zTGTaU7i0';
        
        // Inisialisasi viewer Cesium
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            baseLayerPicker: false,
            animation: false,
            timeline: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            geocoder: false,
            homeButton: false,
            fullscreenButton: false,
            infoBox: false,
            selectionIndicator: false,
            shadows: true,
            shouldAnimate: true,
            imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }) // Bing Maps Aerial
        });
        
        // Hilangkan logo Cesium
        viewer.cesiumWidget.creditContainer.style.display = "none";
        
        // Koordinat Kelurahan Terban, Yogyakarta
        const terbanPosition = Cesium.Cartesian3.fromDegrees(110.376, -7.774, 500);
        
        // Set tampilan awal ke lokasi Terban dengan ketinggian tertentu
        viewer.camera.setView({
            destination: terbanPosition,
            orientation: {
                heading: Cesium.Math.toRadians(0),
                pitch: Cesium.Math.toRadians(-30),
                roll: 0.0
            }
        });
        
        // Tambahkan penanda lokasi Terban
        const terbanEntity = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(110.376, -7.774),
            point: {
                pixelSize: 15,
                color: Cesium.Color.RED,
                outlineColor: Cesium.Color.WHITE,
                outlineWidth: 2
            },
            label: {
                text: "Kelurahan Terban, Yogyakarta",
                font: "14pt sans-serif",
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                outlineWidth: 2,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                pixelOffset: new Cesium.Cartesian2(0, -10)
            },
            description: `<div style="padding: 10px; max-width: 300px;">
                            <h3 style="margin-top:0; color: #2a9fd6;">Kelurahan Terban, Yogyakarta</h3>
                            <p>Kelurahan Terban terletak di Kecamatan Gondokusuman, Kota Yogyakarta, Daerah Istimewa Yogyakarta.</p>
                            <p>Koordinat: -7.774° LS, 110.376° BT</p>
                            <p>Wilayah ini dikenal dengan banyaknya bangunan pendidikan dan kampus.</p>
                         </div>`
        });
        
        // Tambahkan beberapa bangunan di sekitar Terban sebagai contoh
        const buildings = [
            { name: "Universitas Gadjah Mada", lon: 110.377, lat: -7.773, height: 50 },
            { name: "RSUP Dr. Sardjito", lon: 110.374, lat: -7.775, height: 40 },
            { name: "Mall Malioboro", lon: 110.368, lat: -7.792, height: 35 },
            { name: "Kantor Kelurahan Terban", lon: 110.3765, lat: -7.7745, height: 20 },
            { name: "SMA Negeri 3 Yogyakarta", lon: 110.379, lat: -7.778, height: 25 },
            { name: "Pasar Kranggan", lon: 110.371, lat: -7.798, height: 30 }
        ];
        
        buildings.forEach(building => {
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(building.lon, building.lat),
                cylinder: {
                    length: building.height,
                    topRadius: 0.001,
                    bottomRadius: 0.0015,
                    material: Cesium.Color.fromRandom({ alpha: 0.8 }),
                    outline: true,
                    outlineColor: Cesium.Color.BLACK
                },
                label: {
                    text: building.name,
                    font: "12pt sans-serif",
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth: 1,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -building.height*5000)
                }
            });
        });
        
        // Variabel untuk menyimpan state
        let is3DMode = true;
        let isDayTime = true;
        let isMeasuringLength = false;
        let isMeasuringArea = false;
        let measureHandler;
        
        // Fungsi untuk mengubah mode tampilan (3D/2D)
        document.getElementById('toggle3D').addEventListener('click', function() {
            if (!is3DMode) {
                viewer.scene.morphTo3D(2);
                is3DMode = true;
                this.classList.add('active');
                document.getElementById('toggle2D').classList.remove('active');
                document.getElementById('viewMode').textContent = '3D';
            }
        });
        
        document.getElementById('toggle2D').addEventListener('click', function() {
            if (is3DMode) {
                viewer.scene.morphTo2D(2);
                is3DMode = false;
                this.classList.add('active');
                document.getElementById('toggle3D').classList.remove('active');
                document.getElementById('viewMode').textContent = '2D';
            }
        });
        
        // Fungsi untuk mengubah waktu (siang/malam)
        document.getElementById('dayMode').addEventListener('click', function() {
            if (!isDayTime) {
                // Set waktu ke siang hari
                viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date(2023, 5, 15, 12, 0, 0));
                isDayTime = true;
                this.classList.add('active');
                document.getElementById('nightMode').classList.remove('active');
                document.getElementById('timeMode').textContent = 'Siang';
            }
        });
        
        document.getElementById('nightMode').addEventListener('click', function() {
            if (isDayTime) {
                // Set waktu ke malam hari
                viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date(2023, 5, 15, 22, 0, 0));
                isDayTime = false;
                this.classList.add('active');
                document.getElementById('dayMode').classList.remove('active');
                document.getElementById('timeMode').textContent = 'Malam';
            }
        });
        
        // Fungsi untuk mengukur panjang
        document.getElementById('measureLength').addEventListener('click', function() {
            if (isMeasuringLength) {
                // Nonaktifkan pengukuran
                deactivateMeasurement();
                this.classList.remove('active');
                document.getElementById('measureMode').textContent = 'Tidak Aktif';
            } else {
                // Aktifkan pengukuran panjang
                deactivateMeasurement();
                isMeasuringLength = true;
                this.classList.add('active');
                document.getElementById('measureArea').classList.remove('active');
                document.getElementById('measureMode').textContent = 'Panjang';
                
                // Aktifkan alat ukur panjang Cesium
                measureHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
                let positions = [];
                let polyline;
                let labels = [];
                
                measureHandler.setInputAction(function(click) {
                    const earthPosition = viewer.scene.pickPosition(click.position);
                    if (Cesium.defined(earthPosition)) {
                        positions.push(earthPosition);
                        
                        if (positions.length === 1) {
                            // Buat polyline untuk pengukuran
                            polyline = viewer.entities.add({
                                polyline: {
                                    positions: new Cesium.CallbackProperty(function() {
                                        return positions;
                                    }, false),
                                    width: 3,
                                    material: Cesium.Color.YELLOW
                                }
                            });
                        } else if (positions.length > 1) {
                            // Hitung jarak antara dua titik terakhir
                            const lastPoint = positions[positions.length - 2];
                            const currentPoint = positions[positions.length - 1];
                            const distance = Cesium.Cartesian3.distance(lastPoint, currentPoint);
                            
                            // Tambahkan label untuk jarak
                            const labelPosition = Cesium.Cartesian3.midpoint(lastPoint, currentPoint, new Cesium.Cartesian3());
                            const label = viewer.entities.add({
                                position: labelPosition,
                                label: {
                                    text: (distance / 1000).toFixed(2) + ' km',
                                    font: '14px sans-serif',
                                    fillColor: Cesium.Color.WHITE,
                                    outlineColor: Cesium.Color.BLACK,
                                    outlineWidth: 2,
                                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                    pixelOffset: new Cesium.Cartesian2(0, -20)
                                }
                            });
                            labels.push(label);
                            
                            // Hitung total jarak jika ada lebih dari 2 titik
                            if (positions.length > 2) {
                                let totalDistance = 0;
                                for (let i = 1; i < positions.length; i++) {
                                    totalDistance += Cesium.Cartesian3.distance(positions[i-1], positions[i]);
                                }
                                
                                // Update label terakhir dengan total jarak
                                if (labels.length > 0) {
                                    const lastLabel = labels[labels.length - 1];
                                    lastLabel.label.text = (distance / 1000).toFixed(2) + ' km\nTotal: ' + (totalDistance / 1000).toFixed(2) + ' km';
                                }
                            }
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                
                // Klik kanan untuk mengakhiri pengukuran
                measureHandler.setInputAction(function() {
                    deactivateMeasurement();
                    document.getElementById('measureLength').classList.remove('active');
                    document.getElementById('measureMode').textContent = 'Tidak Aktif';
                }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
            }
        });
        
        // Fungsi untuk mengukur luas
        document.getElementById('measureArea').addEventListener('click', function() {
            if (isMeasuringArea) {
                // Nonaktifkan pengukuran
                deactivateMeasurement();
                this.classList.remove('active');
                document.getElementById('measureMode').textContent = 'Tidak Aktif';
            } else {
                // Aktifkan pengukuran luas
                deactivateMeasurement();
                isMeasuringArea = true;
                this.classList.add('active');
                document.getElementById('measureLength').classList.remove('active');
                document.getElementById('measureMode').textContent = 'Luas';
                
                // Aktifkan alat ukur luas
                measureHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
                let positions = [];
                let polygon;
                let areaLabel;
                
                measureHandler.setInputAction(function(click) {
                    const earthPosition = viewer.scene.pickPosition(click.position);
                    if (Cesium.defined(earthPosition)) {
                        positions.push(earthPosition);
                        
                        if (positions.length === 1) {
                            // Buat polygon untuk pengukuran luas
                            polygon = viewer.entities.add({
                                polygon: {
                                    hierarchy: new Cesium.CallbackProperty(function() {
                                        return new Cesium.PolygonHierarchy(positions);
                                    }, false),
                                    material: Cesium.Color.YELLOW.withAlpha(0.3),
                                    outline: true,
                                    outlineColor: Cesium.Color.YELLOW,
                                    outlineWidth: 3
                                }
                            });
                        } else if (positions.length >= 3) {
                            // Hitung luas area
                            const area = Cesium.PolygonGeometry.computeArea(positions);
                            const areaKm2 = area / 1000000;
                            
                            // Buat atau update label luas
                            if (!areaLabel) {
                                // Cari centroid untuk posisi label
                                const centroid = computeCentroid(positions);
                                areaLabel = viewer.entities.add({
                                    position: centroid,
                                    label: {
                                        text: areaKm2.toFixed(3) + ' km²',
                                        font: '14px sans-serif',
                                        fillColor: Cesium.Color.WHITE,
                                        outlineColor: Cesium.Color.BLACK,
                                        outlineWidth: 2,
                                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                        pixelOffset: new Cesium.Cartesian2(0, 0)
                                    }
                                });
                            } else {
                                const centroid = computeCentroid(positions);
                                areaLabel.position = centroid;
                                areaLabel.label.text = areaKm2.toFixed(3) + ' km²';
                            }
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                
                // Klik kanan untuk mengakhiri pengukuran
                measureHandler.setInputAction(function() {
                    deactivateMeasurement();
                    document.getElementById('measureArea').classList.remove('active');
                    document.getElementById('measureMode').textContent = 'Tidak Aktif';
                }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
            }
        });
        
        // Fungsi untuk menghitung centroid dari array posisi
        function computeCentroid(positions) {
            const centroid = new Cesium.Cartesian3();
            for (let i = 0; i < positions.length; i++) {
                Cesium.Cartesian3.add(centroid, positions[i], centroid);
            }
            Cesium.Cartesian3.divideByScalar(centroid, positions.length, centroid);
            return centroid;
        }
        
        // Fungsi untuk menonaktifkan semua pengukuran
        function deactivateMeasurement() {
            if (measureHandler) {
                measureHandler.destroy();
                measureHandler = null;
            }
            
            // Hapus semua entitas pengukuran
            const entities = viewer.entities.values;
            for (let i = entities.length - 1; i >= 0; i--) {
                const entity = entities[i];
                if (entity.polyline || (entity.polygon && entity !== terbanEntity) || 
                    (entity.label && entity.label.text && 
                     (entity.label.text.includes('km') || entity.label.text.includes('km²')))) {
                    viewer.entities.remove(entity);
                }
            }
            
            isMeasuringLength = false;
            isMeasuringArea = false;
        }
        
        // Fungsi untuk reset view ke lokasi awal
        document.getElementById('resetView').addEventListener('click', function() {
            viewer.camera.flyTo({
                destination: terbanPosition,
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-30),
                    roll: 0.0
                },
                duration: 2
            });
            
            // Reset semua pengukuran
            deactivateMeasurement();
            document.getElementById('measureLength').classList.remove('active');
            document.getElementById('measureArea').classList.remove('active');
            document.getElementById('measureMode').textContent = 'Tidak Aktif';
        });
        
        // Inisialisasi waktu ke siang hari
        viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date(2023, 5, 15, 12, 0, 0));
        
        // Tambahkan info lokasi saat ini di pojok kanan bawah
        const locationDisplay = document.createElement('div');
        locationDisplay.style.position = 'absolute';
        locationDisplay.style.bottom = '10px';
        locationDisplay.style.right = '10px';
        locationDisplay.style.backgroundColor = 'rgba(10, 31, 45, 0.8)';
        locationDisplay.style.padding = '8px 12px';
        locationDisplay.style.borderRadius = '4px';
        locationDisplay.style.fontSize = '12px';
        locationDisplay.style.zIndex = '999';
        locationDisplay.innerHTML = '<i class="fas fa-location-dot"></i> Koordinat: Memuat...';
        document.body.appendChild(locationDisplay);
        
        // Update koordinat saat mouse bergerak di peta
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function(movement) {
            const cartesian = viewer.camera.pickEllipsoid(movement.endPosition, viewer.scene.globe.ellipsoid);
            if (cartesian) {
                const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(6);
                const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(6);
                locationDisplay.innerHTML = `<i class="fas fa-location-dot"></i> Lon: ${lon}°, Lat: ${lat}°`;
            }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        
        // Tambahkan event listener untuk membersihkan pengukuran saat mode berubah
        document.getElementById('toggle3D').addEventListener('click', deactivateMeasurement);
        document.getElementById('toggle2D').addEventListener('click', deactivateMeasurement);
        document.getElementById('dayMode').addEventListener('click', deactivateMeasurement);
        document.getElementById('nightMode').addEventListener('click', deactivateMeasurement);
        
        console.log("Peta 3D Kelurahan Terban, Yogyakarta siap digunakan!");
    </script>
</body>
</html>
