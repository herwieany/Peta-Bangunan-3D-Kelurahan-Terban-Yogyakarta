<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Bangunan di Kelurahan Terban, Yogyakarta</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            color: #e0e1dd;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            padding: 20px;
            text-align: center;
            background: rgba(13, 27, 42, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #415a77;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #778da9;
        }
        
        .header p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            color: #e0e1dd;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .cesium-container {
            flex: 1 1 800px;
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        #cesiumViewer {
            width: 100%;
            height: 100%;
        }
        
        .controls-panel {
            flex: 1 1 350px;
            background: rgba(26, 38, 57, 0.85);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #415a77;
        }
        
        .panel-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #415a77;
        }
        
        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .panel-section h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #778da9;
            display: flex;
            align-items: center;
        }
        
        .panel-section h3 i {
            margin-right: 10px;
            font-size: 1.3rem;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e0e1dd;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid #415a77;
            background: rgba(13, 27, 42, 0.8);
            color: #e0e1dd;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #778da9;
            box-shadow: 0 0 0 2px rgba(119, 141, 169, 0.3);
        }
        
        .button {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #415a77 0%, #778da9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .button:hover {
            background: linear-gradient(135deg, #778da9 0%, #415a77 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button.secondary {
            background: linear-gradient(135deg, #1b263b 0%, #415a77 100%);
        }
        
        .button.secondary:hover {
            background: linear-gradient(135deg, #415a77 0%, #1b263b 100%);
        }
        
        .grid-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .grid-controls .button {
            flex: 1;
        }
        
        .h3-info {
            background: rgba(13, 27, 42, 0.8);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .h3-info h4 {
            color: #778da9;
            margin-bottom: 8px;
        }
        
        .status-panel {
            background: rgba(13, 27, 42, 0.8);
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            border-left: 4px solid #415a77;
        }
        
        .status-panel h4 {
            color: #778da9;
            margin-bottom: 10px;
        }
        
        .status-message {
            color: #e0e1dd;
            line-height: 1.5;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .data-card {
            background: rgba(13, 27, 42, 0.8);
            border-radius: 6px;
            padding: 15px;
            border-top: 3px solid #415a77;
        }
        
        .data-card h5 {
            color: #778da9;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .data-card p {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #778da9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .cesium-container, .controls-panel {
                flex: 1 1 auto;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .cesium-container {
                height: 500px;
            }
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #778da9;
            border-top: 1px solid #415a77;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cesium Ion Data Viewer</h1>
        <p>Tampilkan data 2D dan 3D dari Cesium Ion, lakukan analisis grid dengan H3, dan hubungkan dengan server OGC untuk data tambahan.</p>
    </div>
    
    <div class="container">
        <div class="cesium-container">
            <div id="cesiumViewer"></div>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Memuat data dari Cesium Ion...</p>
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="panel-section">
                <h3><i>üì°</i> Cesium Ion Asset</h3>
                <div class="input-group">
                    <label for="assetId">Asset ID Cesium Ion</label>
                    <input type="text" id="assetId" value="1" placeholder="4224206">
                    <small>Contoh: 1 (Bing Maps), 2 (Natural Earth II), 3 (Cesium World Terrain)</small>
                </div>
                <button class="button" id="loadAssetBtn">Muat Data dari Cesium Ion</button>
            </div>
            
            <div class="panel-section">
                <h3><i>üî≤</i> Analisis Grid H3</h3>
                <div class="input-group">
                    <label for="h3Resolution">Resolusi H3</label>
                    <select id="h3Resolution">
                        <option value="0">0 (Terbesar)</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15 (Terkecil)</option>
                    </select>
                </div>
                <div class="grid-controls">
                    <button class="button" id="generateGridBtn">Buat Grid H3</button>
                    <button class="button secondary" id="clearGridBtn">Hapus Grid</button>
                </div>
                
                <div class="h3-info">
                    <h4>Info Grid H3</h4>
                    <p>H3 adalah sistem grid hexagonal dari Uber. Pilih resolusi untuk mengatur ukuran sel grid. Resolusi lebih tinggi berarti sel lebih kecil dan lebih banyak.</p>
                </div>
            </div>
            
            <div class="panel-section">
                <h3><i>üåê</i> Server OGC</h3>
                <div class="input-group">
                    <label for="ogcServerUrl">URL Server OGC</label>
                    <input type="text" id="ogcServerUrl" placeholder="https://example.com/geoserver/wms">
                </div>
                <div class="input-group">
                    <label for="ogcLayer">Layer OGC</label>
                    <input type="text" id="ogcLayer" placeholder="nama_layer">
                </div>
                <button class="button" id="loadOGCBtn">Muat Layer OGC</button>
            </div>
            
            <div class="status-panel">
                <h4>Status Sistem</h4>
                <div class="status-message" id="statusMessage">Siap. Masukkan Asset ID Cesium Ion untuk memulai.</div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FF6B6B;"></div>
                        <span>Data Cesium Ion</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4ECDC4;"></div>
                        <span>Grid H3</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFD166;"></div>
                        <span>Data OGC</span>
                    </div>
                </div>
            </div>
            
            <div class="data-grid">
                <div class="data-card">
                    <h5>Asset ID Aktif</h5>
                    <p id="activeAssetId">-</p>
                </div>
                <div class="data-card">
                    <h5>Jumlah Sel H3</h5>
                    <p id="h3CellCount">0</p>
                </div>
                <div class="data-card">
                    <h5>Layer OGC Aktif</h5>
                    <p id="activeOGCLayer">-</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Cesium Ion Data Viewer dengan H3 Grid dan OGC Integration | Dibuat dengan CesiumJS dan H3.js</p>
    </div>

    <script>
        // Inisialisasi Cesium Viewer
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmYjU1ODcyMy1iMzEyLTRlMzAtODllNy1hYjc4MjE0N2YxNzQiLCJpZCI6MjA5NDA3LCJpYXQiOjE3MTI1OTI1ODJ9.5_1HjW6WjYxJD3sI1qFqLkPQD-vY6JRlO5N-G5JjL0k';
        
        const viewer = new Cesium.Viewer('cesiumViewer', {
            terrainProvider: Cesium.createWorldTerrain(),
            animation: false,
            timeline: false,
            sceneModePicker: true,
            baseLayerPicker: true,
            geocoder: true,
            homeButton: true,
            navigationHelpButton: true,
            fullscreenButton: true,
            infoBox: false,
            selectionIndicator: true,
            shadows: true,
            shouldAnimate: true
        });
        
        // Inisialisasi variabel
        let h3GridEntities = [];
        let currentAssetId = null;
        let currentOgcLayer = null;
        
        // Elemen DOM
        const assetIdInput = document.getElementById('assetId');
        const loadAssetBtn = document.getElementById('loadAssetBtn');
        const h3ResolutionSelect = document.getElementById('h3Resolution');
        const generateGridBtn = document.getElementById('generateGridBtn');
        const clearGridBtn = document.getElementById('clearGridBtn');
        const ogcServerUrlInput = document.getElementById('ogcServerUrl');
        const ogcLayerInput = document.getElementById('ogcLayer');
        const loadOGCBtn = document.getElementById('loadOGCBtn');
        const statusMessage = document.getElementById('statusMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const activeAssetIdElement = document.getElementById('activeAssetId');
        const h3CellCountElement = document.getElementById('h3CellCount');
        const activeOGCLayerElement = document.getElementById('activeOGCLayer');
        
        // Fungsi untuk memperbarui status
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            
            if (type === 'error') {
                statusMessage.style.color = '#FF6B6B';
            } else if (type === 'success') {
                statusMessage.style.color = '#4ECDC4';
            } else {
                statusMessage.style.color = '#e0e1dd';
            }
            
            console.log(`Status: ${message}`);
        }
        
        // Fungsi untuk memuat asset dari Cesium Ion
        async function loadCesiumAsset(assetId) {
            try {
                loadingIndicator.classList.add('active');
                updateStatus(`Memuat asset ID ${assetId} dari Cesium Ion...`);
                
                // Hapus asset sebelumnya jika ada
                if (currentAssetId) {
                    viewer.dataSources.removeAll();
                }
                
                // Load asset dari Cesium Ion
                const asset = await Cesium.IonResource.fromAssetId(parseInt(assetId));
                
                // Tampilkan sebagai imagery layer
                const layer = viewer.imageryLayers.addImageryProvider(
                    new Cesium.IonImageryProvider({ assetId: parseInt(assetId) })
                );
                
                currentAssetId = assetId;
                activeAssetIdElement.textContent = assetId;
                
                updateStatus(`Asset ID ${assetId} berhasil dimuat.`, 'success');
                loadingIndicator.classList.remove('active');
                
                return layer;
            } catch (error) {
                console.error('Error loading Cesium asset:', error);
                updateStatus(`Gagal memuat asset ID ${assetId}: ${error.message}`, 'error');
                loadingIndicator.classList.remove('active');
                return null;
            }
        }
        
        // Fungsi untuk menghasilkan grid H3
        function generateH3Grid() {
            try {
                // Hapus grid sebelumnya
                clearH3Grid();
                
                const resolution = parseInt(h3ResolutionSelect.value);
                updateStatus(`Membuat grid H3 dengan resolusi ${resolution}...`);
                
                // Dapatkan batas viewport saat ini
                const bounds = getViewportBounds();
                if (!bounds) {
                    updateStatus('Tidak dapat mendapatkan batas viewport. Pastikan globe sudah terlihat.', 'error');
                    return;
                }
                
                // Konversi bounds ke koordinat
                const north = bounds.north;
                const south = bounds.south;
                const east = bounds.east;
                const west = bounds.west;
                
                // Buat polygon bounding box
                const bboxPolygon = [
                    [west, north],
                    [east, north],
                    [east, south],
                    [west, south],
                    [west, north]
                ];
                
                // Dapatkan sel H3 yang menutupi bbox
                const hexagons = h3.polygonToCells(bboxPolygon, resolution);
                
                // Untuk setiap hexagon, buat entity di Cesium
                hexagons.forEach(hexId => {
                    // Dapatkan batas hexagon
                    const hexBoundary = h3.cellToBoundary(hexId);
                    
                    // Konversi ke format Cesium
                    const positions = hexBoundary.map(coord => 
                        Cesium.Cartesian3.fromDegrees(coord[1], coord[0])
                    );
                    
                    // Tambahkan entity untuk hexagon
                    const entity = viewer.entities.add({
                        polygon: {
                            hierarchy: new Cesium.PolygonHierarchy(positions),
                            material: Cesium.Color.fromBytes(78, 205, 196, 100),
                            outline: true,
                            outlineColor: Cesium.Color.fromBytes(78, 205, 196, 200),
                            height: 0,
                            extrudedHeight: 100 * Math.random(), // Tinggi acak untuk visualisasi 3D
                            closeTop: true,
                            closeBottom: true
                        },
                        label: {
                            text: hexId.substring(0, 6),
                            font: '12px Arial',
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            outlineWidth: 2,
                            verticalOrigin: Cesium.VerticalOrigin.CENTER,
                            pixelOffset: new Cesium.Cartesian2(0, 0),
                            show: resolution <= 5 // Tampilkan label hanya untuk resolusi rendah
                        }
                    });
                    
                    h3GridEntities.push(entity);
                });
                
                h3CellCountElement.textContent = hexagons.length;
                updateStatus(`Grid H3 berhasil dibuat dengan ${hexagons.length} sel hexagon.`, 'success');
                
            } catch (error) {
                console.error('Error generating H3 grid:', error);
                updateStatus(`Gagal membuat grid H3: ${error.message}`, 'error');
            }
        }
        
        // Fungsi untuk mendapatkan batas viewport
        function getViewportBounds() {
            try {
                const canvas = viewer.scene.canvas;
                const width = canvas.width;
                const height = canvas.height;
                
                // Dapatkan koordinat dari pojok kiri atas dan kanan bawah
                const upperLeft = viewer.scene.camera.pickEllipsoid(new Cesium.Cartesian2(0, 0));
                const lowerRight = viewer.scene.camera.pickEllipsoid(new Cesium.Cartesian2(width, height));
                
                if (!upperLeft || !lowerRight) {
                    return null;
                }
                
                // Konversi ke derajat
                const upperLeftCartographic = Cesium.Cartographic.fromCartesian(upperLeft);
                const lowerRightCartographic = Cesium.Cartographic.fromCartesian(lowerRight);
                
                const west = Cesium.Math.toDegrees(upperLeftCartographic.longitude);
                const north = Cesium.Math.toDegrees(upperLeftCartographic.latitude);
                const east = Cesium.Math.toDegrees(lowerRightCartographic.longitude);
                const south = Cesium.Math.toDegrees(lowerRightCartographic.latitude);
                
                return { north, south, east, west };
            } catch (error) {
                console.error('Error getting viewport bounds:', error);
                return null;
            }
        }
        
        // Fungsi untuk menghapus grid H3
        function clearH3Grid() {
            h3GridEntities.forEach(entity => {
                viewer.entities.remove(entity);
            });
            h3GridEntities = [];
            h3CellCountElement.textContent = '0';
            updateStatus('Grid H3 telah dihapus.');
        }
        
        // Fungsi untuk memuat layer OGC
        function loadOGCLayer() {
            try {
                const serverUrl = ogcServerUrlInput.value.trim();
                const layerName = ogcLayerInput.value.trim();
                
                if (!serverUrl || !layerName) {
                    updateStatus('Harap masukkan URL server OGC dan nama layer.', 'error');
                    return;
                }
                
                updateStatus(`Memuat layer OGC: ${layerName}...`);
                
                // Hapus layer OGC sebelumnya jika ada
                if (currentOgcLayer) {
                    viewer.imageryLayers.remove(currentOgcLayer);
                }
                
                // Coba sebagai WMS layer
                const wmsProvider = new Cesium.WebMapServiceImageryProvider({
                    url: serverUrl,
                    layers: layerName,
                    parameters: {
                        transparent: true,
                        format: 'image/png'
                    }
                });
                
                const layer = viewer.imageryLayers.addImageryProvider(wmsProvider);
                currentOgcLayer = layer;
                activeOGCLayerElement.textContent = layerName;
                
                updateStatus(`Layer OGC ${layerName} berhasil dimuat.`, 'success');
                
            } catch (error) {
                console.error('Error loading OGC layer:', error);
                updateStatus(`Gagal memuat layer OGC: ${error.message}`, 'error');
                
                // Coba alternatif: tampilkan placeholder untuk demo
                if (ogcServerUrlInput.value.includes('example.com')) {
                    activeOGCLayerElement.textContent = 'Layer Demo OGC';
                    updateStatus('Menggunakan layer demo OGC untuk contoh.', 'info');
                }
            }
        }
        
        // Event Listeners
        loadAssetBtn.addEventListener('click', () => {
            const assetId = assetIdInput.value.trim();
            if (assetId) {
                loadCesiumAsset(assetId);
            } else {
                updateStatus('Harap masukkan Asset ID Cesium Ion.', 'error');
            }
        });
        
        generateGridBtn.addEventListener('click', generateH3Grid);
        clearGridBtn.addEventListener('click', clearH3Grid);
        loadOGCBtn.addEventListener('click', loadOGCLayer);
        
        // Event listener untuk Enter key pada input
        assetIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadAssetBtn.click();
            }
        });
        
        ogcServerUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadOGCBtn.click();
            }
        });
        
        ogcLayerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadOGCBtn.click();
            }
        });
        
        // Load default asset saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('Menginisialisasi Cesium Viewer...');
            
            // Zoom ke wilayah Indonesia
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(117.0, -2.0, 5000000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-90),
                    roll: 0.0
                }
            });
            
            // Load default Cesium Ion asset (Bing Maps)
            setTimeout(() => {
                loadCesiumAsset('1');
            }, 1000);
            
            // Set contoh URL OGC untuk demo
            ogcServerUrlInput.value = 'https://demo.geo-solutions.it/geoserver/wms';
            ogcLayerInput.value = 'topp:states';
            
            updateStatus('Sistem siap. Masukkan Asset ID Cesium Ion untuk memulai.');
        });
        
        // Fungsi untuk demo interaktif: tampilkan info saat mengklik entity
        viewer.screenSpaceEventHandler.setInputAction((movement) => {
            const pickedObject = viewer.scene.pick(movement.position);
            if (Cesium.defined(pickedObject) && pickedObject.id) {
                const entity = pickedObject.id;
                
                // Jika entity adalah bagian dari grid H3
                if (h3GridEntities.includes(entity)) {
                    const hexId = entity.label ? entity.label.text._value : 'Unknown H3 Cell';
                    updateStatus(`Sel H3: ${hexId} | Tinggi: ${entity.polygon.extrudedHeight._value.toFixed(1)}m`);
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    </script>
</body>
</html>
