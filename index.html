<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Peta Bangunan Kelurahan Terban, Yogyakarta</title>

  <!-- CesiumJS dari CDN -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* Judul peta di atas, tengah */
    #map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      padding: 6px 14px;
      background: rgba(20, 20, 20, 0.85);
      color: #ffffff;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.03em;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      text-align: center;
      white-space: nowrap;
    }

    #toolbar {
      position: absolute;
      top: 50px;          /* diturunkan sedikit karena ada judul */
      left: 12px;
      z-index: 10;
      background: rgba(20, 20, 20, 0.85);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      min-width: 260px;
    }

    #toolbar h1 {
      font-size: 14px;
      margin: 0 0 6px 0;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #ffd27f;
    }

    #toolbar section {
      margin-top: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.12);
      padding-top: 6px;
    }

    .btn-group {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    button.mode-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      background: #2f2f2f;
      color: #fff;
      transition: background 0.2s, transform 0.1s, box-shadow 0.1s;
    }

    button.mode-btn.active {
      background: #ffb347;
      color: #1b1b1b;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
    }

    button.mode-btn:hover {
      background: #444;
      transform: translateY(-1px);
    }

    .label-inline {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 2px;
      opacity: 0.8;
    }

    input[type="range"] {
      width: 100%;
    }

    #time-display {
      font-size: 11px;
      margin-top: 2px;
      opacity: 0.9;
      text-align: right;
    }

    #status, #measure-info {
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <!-- Judul peta -->
  <div id="map-title">Peta Bangunan Kelurahan Terban, Yogyakarta</div>

  <!-- Panel kontrol -->
  <div id="toolbar">
    <h1>SCENE CONTROLLER</h1>

    <!-- Mode tampilan -->
    <section>
      <div class="label-inline">
        <span>Mode Tampilan</span>
        <span id="mode-label">3D</span>
      </div>
      <div class="btn-group">
        <button id="btn3d" class="mode-btn active">3D</button>
        <button id="btn2d" class="mode-btn">2D</button>
      </div>
    </section>

    <!-- Waktu siang–malam -->
    <section>
      <div class="label-inline">
        <span>Waktu (siang–malam)</span>
        <span>Jam (UTC)</span>
      </div>
      <input id="timeSlider" type="range" min="0" max="23" step="1" value="10" />
      <div id="time-display">Jam 10:00 UTC</div>
      <div class="btn-group" style="margin-top: 6px;">
        <button id="btnPlayTime" class="mode-btn">Animasi</button>
        <button id="btnPauseTime" class="mode-btn">Pause</button>
      </div>
    </section>

    <!-- Tools pengukuran + zoom -->
    <section>
      <div class="label-inline">
        <span>Tools Pengukuran</span>
        <span id="measure-label">Off</span>
      </div>
      <div class="btn-group">
        <button id="btnMeasureDistance" class="mode-btn">Panjang</button>
        <button id="btnMeasureArea" class="mode-btn">Luas</button>
      </div>
      <div class="btn-group" style="margin-top: 4px;">
        <button id="btnMeasureClear" class="mode-btn">Clear</button>
        <button id="btnZoomToData" class="mode-btn">Zoom ke Data</button>
      </div>
      <div id="measure-info">
        Pilih mode, lalu klik di peta untuk menambah titik. Klik kanan untuk selesai.
      </div>
    </section>

    <div id="status">Memuat data…</div>
  </div>

  <div id="cesiumContainer"></div>

  <script>
    // ===== 1. Token & Asset ID dari Cesium ion =====
    Cesium.Ion.defaultAccessToken = 'YOUR_ION_ACCESS_TOKEN'; // GANTI di sini

    const ASSET_ID_3D = 4224210;   // ganti dengan asset ID 3D Anda
    const ASSET_ID_2D = 4224206;   // ganti dengan asset ID 2D Anda

    // ===== 2. Inisialisasi viewer =====
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: true,
      timeline: true,
      sceneMode: Cesium.SceneMode.SCENE3D,
      geocoder: false,
      homeButton: true,
      sceneModePicker: true,
      baseLayerPicker: true,
      navigationHelpButton: false,
      fullscreenButton: true
    });

    viewer.scene.globe.enableLighting = true;
    viewer.shadows = true;
    viewer.clock.shouldAnimate = false;

    const statusEl = document.getElementById('status');
    const modeLabelEl = document.getElementById('mode-label');
    const btn3d = document.getElementById('btn3d');
    const btn2d = document.getElementById('btn2d');
    const timeSlider = document.getElementById('timeSlider');
    const timeDisplay = document.getElementById('time-display');
    const btnPlayTime = document.getElementById('btnPlayTime');
    const btnPauseTime = document.getElementById('btnPauseTime');

    const btnMeasureDistance = document.getElementById('btnMeasureDistance');
    const btnMeasureArea = document.getElementById('btnMeasureArea');
    const btnMeasureClear = document.getElementById('btnMeasureClear');
    const btnZoomToData = document.getElementById('btnZoomToData');
    const measureLabelEl = document.getElementById('measure-label');
    const measureInfoEl = document.getElementById('measure-info');

    function setModeButton(active) {
      if (active === '3d') {
        btn3d.classList.add('active');
        btn2d.classList.remove('active');
        modeLabelEl.textContent = '3D';
      } else {
        btn2d.classList.add('active');
        btn3d.classList.remove('active');
        modeLabelEl.textContent = '2D';
      }
    }

    // ===== 3. Muat data =====
    let tileset3D = null;
    let dataSource2D = null;

    async function loadData() {
      try {
        statusEl.textContent = 'Memuat 3D Tiles…';
        tileset3D = await Cesium.Cesium3DTileset.fromIonAssetId(ASSET_ID_3D);
        viewer.scene.primitives.add(tileset3D);

        statusEl.textContent = 'Memuat data 2D…';
        dataSource2D = await Cesium.GeoJsonDataSource.fromIonAssetId(ASSET_ID_2D);
        viewer.dataSources.add(dataSource2D);

        const entities = dataSource2D.entities.values;
        for (let i = 0; i < entities.length; i++) {
          const e = entities[i];
          if (e.polygon) {
            e.polygon.material = Cesium.Color.ORANGE.withAlpha(0.6);
            e.polygon.outline = true;
            e.polygon.outlineColor = Cesium.Color.DARKRED;
          }
          if (e.polyline) {
            e.polyline.width = 2.0;
            e.polyline.material = Cesium.Color.CYAN;
          }
          if (e.point) {
            e.point.pixelSize = 8;
            e.point.color = Cesium.Color.YELLOW;
            e.point.outlineColor = Cesium.Color.BLACK;
            e.point.outlineWidth = 1;
          }
        }

        await viewer.flyTo(tileset3D);
        statusEl.textContent = 'Data siap. Gunakan panel untuk ganti mode, waktu, dan pengukuran.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Gagal memuat data. Cek Asset ID dan token.';
      }
    }

    loadData();

    btnZoomToData.addEventListener('click', function () {
      if (tileset3D) {
        viewer.flyTo(tileset3D);
      } else if (dataSource2D) {
        viewer.flyTo(dataSource2D);
      }
    });

    // ===== 4. 2D / 3D =====
    btn3d.addEventListener('click', function () {
      viewer.scene.morphTo3D(1.5);
      setModeButton('3d');
    });

    btn2d.addEventListener('click', function () {
      viewer.scene.morphTo2D(1.5);
      setModeButton('2d');
    });

    // ===== 5. Waktu =====
    function updateTimeFromSlider() {
      const hour = parseInt(timeSlider.value, 10);
      const now = Cesium.JulianDate.now();
      const gregorian = Cesium.JulianDate.toDate(now);
      gregorian.setUTCHours(hour, 0, 0, 0);
      const newTime = Cesium.JulianDate.fromDate(gregorian);
      viewer.clock.currentTime = newTime;
      viewer.clock.shouldAnimate = false;

      const hourStr = hour.toString().padStart(2, '0');
      timeDisplay.textContent = `Jam ${hourStr}:00 UTC`;
    }

    timeSlider.addEventListener('input', updateTimeFromSlider);
    updateTimeFromSlider();

    btnPlayTime.addEventListener('click', function () {
      viewer.clock.shouldAnimate = true;
      viewer.clock.multiplier = 4000;
      statusEl.textContent = 'Animasi waktu berjalan.';
    });

    btnPauseTime.addEventListener('click', function () {
      viewer.clock.shouldAnimate = false;
      statusEl.textContent = 'Animasi waktu dihentikan. Anda dapat geser slider jam.';
    });

    // ===== 6. Alat ukur =====
    let measureMode = null;
    let measurePositions = [];
    let measureShapeEntity = null;
    let measureLabelEntity = null;
    let measurePointEntities = [];

    function setMeasureMode(mode) {
      measureMode = mode;
      if (mode === 'distance') {
        measureLabelEl.textContent = 'Panjang';
        btnMeasureDistance.classList.add('active');
        btnMeasureArea.classList.remove('active');
        measureInfoEl.textContent = 'Mode panjang: klik di peta untuk membuat garis, klik kanan untuk selesai.';
      } else if (mode === 'area') {
        measureLabelEl.textContent = 'Luas';
        btnMeasureArea.classList.add('active');
        btnMeasureDistance.classList.remove('active');
        measureInfoEl.textContent = 'Mode luas: klik di peta untuk membuat poligon, klik kanan untuk selesai.';
      } else {
        measureLabelEl.textContent = 'Off';
        btnMeasureArea.classList.remove('active');
        btnMeasureDistance.classList.remove('active');
        measureInfoEl.textContent = 'Pilih mode, lalu klik di peta untuk menambah titik. Klik kanan untuk selesai.';
      }
    }

    function clearMeasurement() {
      measurePositions = [];
      if (measureShapeEntity) {
        viewer.entities.remove(measureShapeEntity);
        measureShapeEntity = null;
      }
      if (measureLabelEntity) {
        viewer.entities.remove(measureLabelEntity);
        measureLabelEntity = null;
      }
      for (const p of measurePointEntities) {
        viewer.entities.remove(p);
      }
      measurePointEntities = [];
      measureInfoEl.textContent = 'Pengukuran dibersihkan. Pilih mode untuk mulai lagi.';
    }

    btnMeasureDistance.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode('distance');
    });

    btnMeasureArea.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode('area');
    });

    btnMeasureClear.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode(null);
    });

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction(function (click) {
      if (!measureMode) return;

      let cartesian = viewer.scene.pickPosition(click.position);
      if (!Cesium.defined(cartesian)) {
        cartesian = viewer.camera.pickEllipsoid(
          click.position,
          viewer.scene.globe.ellipsoid
        );
      }
      if (!cartesian) return;

      measurePositions.push(cartesian);

      const point = viewer.entities.add({
        position: cartesian,
        point: {
          pixelSize: 8,
          color: Cesium.Color.LIME,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 1
        }
      });
      measurePointEntities.push(point);

      updateMeasurement();
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction(function () {
      if (!measureMode) return;
      measureInfoEl.textContent += '  (Pengukuran selesai, gunakan Clear untuk menghapus.)';
      measureMode = null;
      measureLabelEl.textContent = 'Off';
      btnMeasureArea.classList.remove('active');
      btnMeasureDistance.classList.remove('active');
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

    function updateMeasurement() {
      if (measureMode === 'distance' && measurePositions.length >= 2) {
        if (!measureShapeEntity) {
          measureShapeEntity = viewer.entities.add({
            polyline: {
              positions: measurePositions,
              width: 3,
              material: Cesium.Color.LIME
            }
          });
        }

        const ellipsoid = Cesium.Ellipsoid.WGS84;
        let total = 0.0;
        for (let i = 1; i < measurePositions.length; i++) {
          const c1 = ellipsoid.cartesianToCartographic(measurePositions[i - 1]);
          const c2 = ellipsoid.cartesianToCartographic(measurePositions[i]);
          const geodesic = new Cesium.EllipsoidGeodesic(c1, c2);
          total += geodesic.surfaceDistance;
        }

        const lastPos = measurePositions[measurePositions.length - 1];

        const km = total / 1000.0;
        const text = km >= 1
          ? `Panjang: ${km.toFixed(3)} km`
          : `Panjang: ${total.toFixed(1)} m`;

        if (!measureLabelEntity) {
          measureLabelEntity = viewer.entities.add({
            position: lastPos,
            label: {
              text: text,
              font: '14px sans-serif',
              fillColor: Cesium.Color.WHITE,
              outlineColor: Cesium.Color.BLACK,
              outlineWidth: 2,
              style: Cesium.LabelStyle.FILL_AND_OUTLINE,
              verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
              pixelOffset: new Cesium.Cartesian2(0, -10)
            }
          });
        } else {
          measureLabelEntity.position = lastPos;
          measureLabelEntity.label.text = text;
        }

        measureInfoEl.textContent = text;
      }

      if (measureMode === 'area' && measurePositions.length >= 3) {
        if (!measureShapeEntity) {
          measureShapeEntity = viewer.entities.add({
            polygon: {
              hierarchy: new Cesium.CallbackProperty(function () {
                return new Cesium.PolygonHierarchy(measurePositions);
              }, false),
              material: Cesium.Color.LIME.withAlpha(0.3),
              outline: true,
              outlineColor: Cesium.Color.LIME
            }
          });
        }

        const R = 6378137.0;
        const cartos = measurePositions.map(p => Cesium.Cartographic.fromCartesian(p));
        const lat0 = cartos[0].latitude;
        const cosLat0 = Math.cos(lat0);

        const xy = cartos.map(c => {
          const x = R * c.longitude * cosLat0;
          const y = R * c.latitude * R / R;
          return { x, y };
        });

        let area = 0.0;
        for (let i = 0; i < xy.length; i++) {
          const j = (i + 1) % xy.length;
          area += xy[i].x * xy[j].y - xy[j].x * xy[i].y;
        }
        area = Math.abs(area) * 0.5;

        const ha = area / 10000.0;
        const km2 = area / 1e6;
        let text;
        if (km2 >= 1) {
          text = `Luas: ${km2.toFixed(3)} km²`;
        } else if (ha >= 1) {
          text = `Luas: ${ha.toFixed(2)} ha`;
        } else {
          text = `Luas: ${area.toFixed(1)} m²`;
        }

        let sumX = 0, sumY = 0, sumZ = 0;
        for (const p of measurePositions) {
          sumX += p.x; sumY += p.y; sumZ += p.z;
        }
        const center = new Cesium.Cartesian3(
          sumX / measurePositions.length,
          sumY / measurePositions.length,
          sumZ / measurePositions.length
        );

        if (!measureLabelEntity) {
          measureLabelEntity = viewer.entities.add({
            position: center,
            label: {
              text: text,
              font: '14px sans-serif',
              fillColor: Cesium.Color.WHITE,
              outlineColor: Cesium.Color.BLACK,
              outlineWidth: 2,
              style: Cesium.LabelStyle.FILL_AND_OUTLINE,
              verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
              pixelOffset: new Cesium.Cartesian2(0, -10)
            }
          });
        } else {
          measureLabelEntity.position = center;
          measureLabelEntity.label.text = text;
        }

        measureInfoEl.textContent = text;
      }
    }
  </script>
</body>
</html>
