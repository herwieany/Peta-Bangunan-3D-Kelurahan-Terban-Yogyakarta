<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Peta Bangunan Kelurahan Terban, Yogyakarta</title>

  <!-- CesiumJS dari CDN -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2ff 0, #c0ccf2 45%, #8a9ac4 100%);
    }

    /* Judul peta */
    #map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      padding: 6px 20px;
      background: linear-gradient(120deg, rgba(40, 120, 230, 0.98), rgba(132, 210, 255, 0.96));
      color: #ffffff;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 650;
      letter-spacing: 0.06em;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* Panel kontrol (glass, biru) */
    #toolbar {
      position: absolute;
      top: 58px;
      left: 16px;
      z-index: 10;
      padding: 12px 14px;
      min-width: 280px;

      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.9), rgba(230, 243, 255, 0.93));
      border-radius: 18px;
      box-shadow:
        0 18px 45px rgba(0, 0, 0, 0.35),
        0 0 0 1px rgba(255, 255, 255, 0.9);
      color: #1c2435;
    }

    #toolbar h1 {
      font-size: 13px;
      margin: 0 0 6px 0;
      font-weight: 650;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #2956a3;
    }

    #toolbar section {
      margin-top: 6px;
      border-top: 1px solid rgba(120, 140, 190, 0.35);
      padding-top: 6px;
    }

    .btn-group {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    button.mode-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      cursor: pointer;
      background: rgba(230, 238, 255, 0.9);
      color: #1f2937;
      transition: background 0.18s, transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 0 0 1px rgba(148, 163, 209, 0.6);
    }

    button.mode-btn.active {
      background: linear-gradient(120deg, #2563eb, #60a5fa);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(191, 219, 254, 0.9),
        0 8px 18px rgba(15, 23, 42, 0.45);
    }

    button.mode-btn:hover {
      background: rgba(209, 226, 255, 0.95);
      transform: translateY(-1px);
    }

    .label-inline {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 2px;
      opacity: 0.9;
    }

    input[type="range"] {
      width: 100%;
      accent-color: #2563eb;
    }

    #time-display {
      font-size: 11px;
      margin-top: 2px;
      opacity: 0.9;
      text-align: right;
    }

    #status, #measure-info {
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.8;
    }

    /* Hint bawah kiri */
    #hint-badge {
      position: absolute;
      left: 16px;
      bottom: 16px;
      z-index: 8;
      padding: 6px 10px;
      font-size: 11px;
      color: #0f172a;
      background: rgba(239, 246, 255, 0.96);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 209, 0.7);
      max-width: 260px;
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <!-- Judul peta -->
  <div id="map-title">Peta Bangunan Kelurahan Terban, Yogyakarta</div>

  <!-- Panel kontrol -->
  <div id="toolbar">
    <h1>SCENE CONTROLLER</h1>

    <!-- Mode tampilan -->
    <section>
      <div class="label-inline">
        <span>Mode Tampilan</span>
        <span id="mode-label">3D</span>
      </div>
      <div class="btn-group">
        <button id="btn3d" class="mode-btn active">3D</button>
        <button id="btn2d" class="mode-btn">2D</button>
      </div>
    </section>

    <!-- Waktu siang–malam -->
    <section>
      <div class="label-inline">
        <span>Waktu (siang–malam)</span>
        <span>Jam (UTC)</span>
      </div>
      <input id="timeSlider" type="range" min="0" max="23" step="1" value="10" />
      <div id="time-display">Jam 10:00 UTC</div>
      <div class="btn-group" style="margin-top: 6px;">
        <button id="btnPlayTime" class="mode-btn">Animasi</button>
        <button id="btnPauseTime" class="mode-btn">Pause</button>
      </div>
    </section>

    <!-- Tools pengukuran + zoom -->
    <section>
      <div class="label-inline">
        <span>Tools Pengukuran</span>
        <span id="measure-label">Off</span>
      </div>
      <div class="btn-group">
        <button id="btnMeasureDistance" class="mode-btn">Panjang</button>
        <button id="btnMeasureArea" class="mode-btn">Luas</button>
      </div>
      <div class="btn-group" style="margin-top: 4px;">
        <button id="btnMeasureClear" class="mode-btn">Clear</button>
        <button id="btnZoomToData" class="mode-btn">Zoom ke Data</button>
      </div>
      <div id="measure-info">
        Pilih mode, lalu klik di peta untuk menambah titik. Klik kanan untuk selesai.
      </div>
    </section>

    <div id="status">Memuat data…</div>
  </div>

  <!-- Hint -->
  <div id="hint-badge">
    Gunakan <b>3D / 2D</b> untuk mengubah tampilan, slider untuk siang–malam, dan mode
    <b>Panjang</b> atau <b>Luas</b> untuk analisis di sekitar bangunan Kelurahan Terban.
  </div>

  <!-- Container Cesium -->
  <div id="cesiumContainer"></div>

  <script>
    // ===== 1. Token & Asset ID =====
    Cesium.Ion.defaultAccessToken = 'yJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwNTY2Y2Y1Ni02YWUyLTQ1OWQtODcyYi1lZGM5OTJhOWI1OWQiLCJpZCI6MjEzNjk3LCJpYXQiOjE3NjU4NjA2NzF9.37HTp-nTHxNr4umeQruV45iHJnaxmJsS94B_yUIdm28'; // GANTI

    const ASSET_ID_3D = 4224210;   // ganti dengan asset 3D Anda
    const ASSET_ID_2D = 4224206;   // ganti dengan asset 2D Anda

    // ===== 2. Inisialisasi viewer =====
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: true,
      timeline: true,
      sceneMode: Cesium.SceneMode.SCENE3D,
      geocoder: false,
      homeButton: true,
      sceneModePicker: true,
      baseLayerPicker: true,
      navigationHelpButton: false,
      fullscreenButton: true
    });

    // Ganti basemap default ke peta jalan (bukan citra satelit)
    (async function () {
      const roadImagery = await Cesium.createWorldImageryAsync({
        style: Cesium.IonWorldImageryStyle.ROAD
      });
      viewer.imageryLayers.removeAll();
      viewer.imageryLayers.addImageryProvider(roadImagery);
    })();

    viewer.scene.globe.enableLighting = true;
    viewer.shadows = true;
    viewer.clock.shouldAnimate = false;

    const statusEl = document.getElementById('status');
    const modeLabelEl = document.getElementById('mode-label');
    const btn3d = document.getElementById('btn3d');
    const btn2d = document.getElementById('btn2d');
    const timeSlider = document.getElementById('timeSlider');
    const timeDisplay = document.getElementById('time-display');
    const btnPlayTime = document.getElementById('btnPlayTime');
    const btnPauseTime = document.getElementById('btnPauseTime');

    const btnMeasureDistance = document.getElementById('btnMeasureDistance');
    const btnMeasureArea = document.getElementById('btnMeasureArea');
    const btnMeasureClear = document.getElementById('btnMeasureClear');
    const btnZoomToData = document.getElementById('btnZoomToData');
    const measureLabelEl = document.getElementById('measure-label');
    const measureInfoEl = document.getElementById('measure-info');

    function setModeButton(active) {
      if (active === '3d') {
        btn3d.classList.add('active');
        btn2d.classList.remove('active');
        modeLabelEl.textContent = '3D';
      } else {
        btn2d.classList.add('active');
        btn3d.classList.remove('active');
        modeLabelEl.textContent = '2D';
      }
    }

    // ===== 3. Muat data & zoom default ke Terban =====
    let tileset3D = null;
    let dataSource2D = null;

    async function loadData() {
      try {
        statusEl.textContent = 'Memuat 3D Tiles…';
        tileset3D = await Cesium.Cesium3DTileset.fromIonAssetId(ASSET_ID_3D);
        viewer.scene.primitives.add(tileset3D);

        statusEl.textContent = 'Memuat data 2D…';
        dataSource2D = await Cesium.GeoJsonDataSource.fromIonAssetId(ASSET_ID_2D);
        viewer.dataSources.add(dataSource2D);

        const entities = dataSource2D.entities.values;
        for (let i = 0; i < entities.length; i++) {
          const e = entities[i];
          if (e.polygon) {
            e.polygon.material = Cesium.Color.fromCssColorString('#fb923c').withAlpha(0.65);
            e.polygon.outline = true;
            e.polygon.outlineColor = Cesium.Color.fromCssColorString('#b45309');
          }
          if (e.polyline) {
            e.polyline.width = 2.2;
            e.polyline.material = Cesium.Color.fromCssColorString('#0ea5e9');
          }
          if (e.point) {
            e.point.pixelSize = 8;
            e.point.color = Cesium.Color.fromCssColorString('#facc15');
            e.point.outlineColor = Cesium.Color.fromCssColorString('#1f2937');
            e.point.outlineWidth = 1;
          }
        }

        // Zoom awal langsung ke bounding sphere 3D Tiles
        const bs = tileset3D.boundingSphere;
        viewer.camera.flyToBoundingSphere(bs, {
          duration: 0.0,
          offset: new Cesium.HeadingPitchRange(
            Cesium.Math.toRadians(-35.0),
            Cesium.Math.toRadians(-35.0),
            bs.radius * 2.5
          )
        });

        // Set tombol Home kembali ke area Terban
        viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function (e) {
          e.cancel = true;
          viewer.camera.flyToBoundingSphere(bs, {
            duration: 1.2,
            offset: new Cesium.HeadingPitchRange(
              Cesium.Math.toRadians(-35.0),
              Cesium.Math.toRadians(-35.0),
              bs.radius * 2.5
            )
          });
        });

        statusEl.textContent = 'Data siap. Gunakan panel untuk ganti mode, waktu, dan pengukuran.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Gagal memuat data. Cek Asset ID dan token.';
      }
    }

    loadData();

    // Zoom ke data via tombol
    btnZoomToData.addEventListener('click', function () {
      if (tileset3D) {
        const bs = tileset3D.boundingSphere;
        viewer.camera.flyToBoundingSphere(bs, {
          duration: 1.2,
          offset: new Cesium.HeadingPitchRange(
            Cesium.Math.toRadians(-35.0),
            Cesium.Math.toRadians(-35.0),
            bs.radius * 2.5
          )
        });
      } else if (dataSource2D) {
        viewer.flyTo(dataSource2D);
      }
    });

    // ===== 4. 2D / 3D =====
    btn3d.addEventListener('click', function () {
      viewer.scene.morphTo3D(1.1);
      setModeButton('3d');
    });

    btn2d.addEventListener('click', function () {
      viewer.scene.morphTo2D(1.1);
      setModeButton('2d');
    });

    // ===== 5. Waktu siang–malam =====
    function updateTimeFromSlider() {
      const hour = parseInt(timeSlider.value, 10);
      const now = Cesium.JulianDate.now();
      const gregorian = Cesium.JulianDate.toDate(now);
      gregorian.setUTCHours(hour, 0, 0, 0);
      const newTime = Cesium.JulianDate.fromDate(gregorian);
      viewer.clock.currentTime = newTime;
      viewer.clock.shouldAnimate = false;

      const hourStr = hour.toString().padStart(2, '0');
      timeDisplay.textContent = `Jam ${hourStr}:00 UTC`;
    }

    timeSlider.addEventListener('input', updateTimeFromSlider);
    updateTimeFromSlider();

    btnPlayTime.addEventListener('click', function () {
      viewer.clock.shouldAnimate = true;
      viewer.clock.multiplier = 4000;
      statusEl.textContent = 'Animasi waktu berjalan.';
    });

    btnPauseTime.addEventListener('click', function () {
      viewer.clock.shouldAnimate = false;
      statusEl.textContent = 'Animasi waktu dihentikan. Anda dapat geser slider jam.';
    });

    // ===== 6. Alat ukur jarak & luas =====
    let measureMode = null;
    let measurePositions = [];
    let measureShapeEntity = null;
    let measureLabelEntity = null;
    let measurePointEntities = [];

    function setMeasureMode(mode) {
      measureMode = mode;
      if (mode === 'distance') {
        measureLabelEl.textContent = 'Panjang';
        btnMeasureDistance.classList.add('active');
        btnMeasureArea.classList.remove('active');
        measureInfoEl.textContent = 'Mode panjang: klik di peta untuk membuat garis, klik kanan untuk selesai.';
      } else if (mode === 'area') {
        measureLabelEl.textContent = 'Luas';
        btnMeasureArea.classList.add('active');
        btnMeasureDistance.classList.remove('active');
        measureInfoEl.textContent = 'Mode luas: klik di peta untuk membuat poligon, klik kanan untuk selesai.';
      } else {
        measureLabelEl.textContent = 'Off';
        btnMeasureArea.classList.remove('active');
        btnMeasureDistance.classList.remove('active');
        measureInfoEl.textContent = 'Pilih mode, lalu klik di peta untuk menambah titik. Klik kanan untuk selesai.';
      }
    }

    function clearMeasurement() {
      measurePositions = [];
      if (measureShapeEntity) {
        viewer.entities.remove(measureShapeEntity);
        measureShapeEntity = null;
      }
      if (measureLabelEntity) {
        viewer.entities.remove(measureLabelEntity);
        measureLabelEntity = null;
      }
      for (const p of measurePointEntities) {
        viewer.entities.remove(p);
      }
      measurePointEntities = [];
      measureInfoEl.textContent = 'Pengukuran dibersihkan. Pilih mode untuk mulai lagi.';
    }

    btnMeasureDistance.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode('distance');
    });

    btnMeasureArea.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode('area');
    });

    btnMeasureClear.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode(null);
    });

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction(function (click) {
      if (!measureMode) return;

      let cartesian = viewer.scene.pickPosition(click.position);
      if (!Cesium.defined(cartesian)) {
        cartesian = viewer.camera.pickEllipsoid(
          click.position,
          viewer.scene.globe.ellipsoid
        );
      }
      if (!cartesian) return;

      measurePositions.push(cartesian);

      const point = viewer.entities.add({
        position: cartesian,
        point: {
          pixelSize: 8,
          color: Cesium.Color.fromCssColorString('#22c55e'),
          outlineColor: Cesium.Color.fromCssColorString('#111827'),
          outlineWidth: 1
        }
      });
      measurePointEntities.push(point);

      updateMeasurement();
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction(function () {
      if (!measureMode) return;
      measureInfoEl.textContent += '  (Pengukuran selesai, gunakan Clear untuk menghapus.)';
      measureMode = null;
      measureLabelEl.textContent = 'Off';
      btnMeasureArea.classList.remove('active');
      btnMeasureDistance.classList.remove('active');
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

    function updateMeasurement() {
      if (measureMode === 'distance' && measurePositions.length >= 2) {
        if (!measureShapeEntity) {
          measureShapeEntity = viewer.entities.add({
            polyline: {
              positions: measurePositions,
              width: 3,
              material: Cesium.Color.fromCssColorString('#22c55e')
            }
          });
        }

        const ellipsoid = Cesium.Ellipsoid.WGS84;
        let total = 0.0;
        for (let i = 1; i < measurePositions.length; i++) {
          const c1 = ellipsoid.cart
