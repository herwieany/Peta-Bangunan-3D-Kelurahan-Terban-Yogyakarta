<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Peta Bangunan Kelurahan Terban, Yogyakarta</title>

  <!-- CesiumJS dari CDN -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #dfe8ff 0, #a6b7e6 40%, #7f8fc5 70%, #5a6ca5 100%);
    }

    /* Judul */
    #map-title {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      padding: 8px 24px;
      border-radius: 999px;
      background: linear-gradient(120deg, #3498ff, #7fd0ff);
      color: #ffffff;
      font-size: 15px;
      font-weight: 650;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
      white-space: nowrap;
    }

    /* Panel kontrol kiri */
    #toolbar {
      position: absolute;
      top: 70px;
      left: 18px;
      z-index: 10;
      padding: 14px 16px;
      min-width: 280px;

      background: rgba(255, 255, 255, 0.90);
      border-radius: 22px;
      box-shadow:
        0 18px 50px rgba(103, 126, 186, 0.55),
        0 0 0 1px rgba(255, 255, 255, 0.9);
      color: #1f2933;
    }

    #toolbar h1 {
      font-size: 13px;
      margin: 0 0 8px 0;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #355395;
    }

    #toolbar section {
      margin-top: 8px;
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      padding-top: 8px;
    }

    .label-inline {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 3px;
      color: #4b5563;
    }

    .btn-group {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    button.mode-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #ecf0ff;
      color: #334155;
      transition: background 0.16s, transform 0.08s, box-shadow 0.08s;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.45);
    }

    button.mode-btn.active {
      background: linear-gradient(120deg, #2563eb, #60a5fa);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(191, 219, 254, 1),
        0 10px 22px rgba(37, 99, 235, 0.45);
    }

    button.mode-btn:hover {
      background: #dde5ff;
      transform: translateY(-1px);
    }

    input[type="range"] {
      width: 100%;
      accent-color: #2563eb;
    }

    #time-display {
      font-size: 11px;
      margin-top: 2px;
      text-align: right;
      color: #4b5563;
    }

    #status, #measure-info {
      font-size: 11px;
      margin-top: 5px;
      color: #6b7280;
    }

    /* Hint di bawah kiri */
    #hint-badge {
      position: absolute;
      left: 18px;
      bottom: 18px;
      z-index: 8;
      padding: 6px 10px;
      font-size: 11px;
      color: #f9fafb;
      background: rgba(15, 23, 42, 0.90);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      max-width: 260px;
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <div id="map-title">Peta Bangunan Kelurahan Terban, Yogyakarta</div>

  <div id="toolbar">
    <h1>SCENE CONTROLLER</h1>

    <section>
      <div class="label-inline">
        <span>Mode Tampilan</span>
        <span id="mode-label">3D</span>
      </div>
      <div class="btn-group">
        <button id="btn3d" class="mode-btn active">3D</button>
        <button id="btn2d" class="mode-btn">2D</button>
      </div>
    </section>

    <section>
      <div class="label-inline">
        <span>Waktu (siang–malam)</span>
        <span>Jam (UTC)</span>
      </div>
      <input id="timeSlider" type="range" min="0" max="23" step="1" value="10" />
      <div id="time-display">Jam 10:00 UTC</div>
      <div class="btn-group" style="margin-top: 6px;">
        <button id="btnPlayTime" class="mode-btn">Animasi</button>
        <button id="btnPauseTime" class="mode-btn">Pause</button>
      </div>
    </section>

    <section>
      <div class="label-inline">
        <span>Tools Pengukuran</span>
        <span id="measure-label">Off</span>
      </div>
      <div class="btn-group">
        <button id="btnMeasureDistance" class="mode-btn">Panjang</button>
        <button id="btnMeasureArea" class="mode-btn">Luas</button>
      </div>
      <div class="btn-group" style="margin-top: 4px;">
        <button id="btnMeasureClear" class="mode-btn">Clear</button>
        <button id="btnZoomToData" class="mode-btn">Zoom ke Data</button>
      </div>
      <div id="measure-info">
        Pilih mode, lalu klik di peta untuk menambah titik. Klik kanan untuk selesai.
      </div>
    </section>

    <div id="status">Memuat data…</div>
  </div>

  <div id="hint-badge">
    Gunakan <b>3D / 2D</b> untuk mengubah tampilan, slider untuk siang–malam,
    dan mode <b>Panjang</b> / <b>Luas</b> untuk mengukur di sekitar bangunan Terban.
  </div>

  <div id="cesiumContainer"></div>

  <script>
    // ===== 1. Token & Asset ID =====
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0YjQ4NTk0NS0wZmE5LTQ3ZWEtOTEzYy0xZTZhN2E4NmU5MTgiLCJpZCI6MjEzNjk3LCJpYXQiOjE3NjU4NzQxMzd9.rWDk_DtxtgruoJjwcQovfDqYAAUoBPUI531Bm7LvH8U'; // GANTI di sini

    const ASSET_ID_3D = 4224210;   // ganti dengan asset 3D Anda
    const ASSET_ID_2D = 4224206;   // ganti dengan asset 2D Anda

    // ===== 2. Viewer (dengan base map non-satelit) =====
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: true,
      timeline: true,
      sceneMode: Cesium.SceneMode.SCENE3D,
      geocoder: false,
      homeButton: true,
      sceneModePicker: true,
      baseLayerPicker: false,     // kita ubah base map sendiri
      navigationHelpButton: false,
      fullscreenButton: true
    });

    // Ganti base map: gunakan world imagery gaya ROAD (bukan citra satelit)
    (async () => {
      viewer.imageryLayers.removeAll();
      const roadImagery = await Cesium.createWorldImageryAsync({
        style: Cesium.IonWorldImageryStyle.ROAD
      });
      viewer.imageryLayers.addImageryProvider(roadImagery);
    })();

    viewer.scene.globe.enableLighting = true;
    viewer.shadows = true;
    viewer.clock.shouldAnimate = false;

    const statusEl = document.getElementById('status');
    const modeLabelEl = document.getElementById('mode-label');
    const btn3d = document.getElementById('btn3d');
    const btn2d = document.getElementById('btn2d');
    const timeSlider = document.getElementById('timeSlider');
    const timeDisplay = document.getElementById('time-display');
    const btnPlayTime = document.getElementById('btnPlayTime');
    const btnPauseTime = document.getElementById('btnPauseTime');

    const btnMeasureDistance = document.getElementById('btnMeasureDistance');
    const btnMeasureArea = document.getElementById('btnMeasureArea');
    const btnMeasureClear = document.getElementById('btnMeasureClear');
    const btnZoomToData = document.getElementById('btnZoomToData');
    const measureLabelEl = document.getElementById('measure-label');
    const measureInfoEl = document.getElementById('measure-info');

    function setModeButton(active) {
      if (active === '3d') {
        btn3d.classList.add('active');
        btn2d.classList.remove('active');
        modeLabelEl.textContent = '3D';
      } else {
        btn2d.classList.add('active');
        btn3d.classList.remove('active');
        modeLabelEl.textContent = '2D';
      }
    }

    // ===== 3. Muat data & zoom default ke Terban =====
    let tileset3D = null;
    let dataSource2D = null;

    let tileset3D = null;
let dataSource2D = null;

async function loadData() {
  // 1) MUAT 3D TILES DULU
  try {
    statusEl.textContent = 'Memuat 3D Tiles…';
    tileset3D = await Cesium.Cesium3DTileset.fromIonAssetId(ASSET_ID_3D);
    viewer.scene.primitives.add(tileset3D);

    // === LANGSUNG ZOOM KE AREA DATA SAAT PERTAMA KALI BUKA ===
    const bs = tileset3D.boundingSphere;

    // view awal (tanpa animasi panjang)
    viewer.camera.flyToBoundingSphere(bs, {
      duration: 0.0,
      offset: new Cesium.HeadingPitchRange(
        Cesium.Math.toRadians(-35.0),  // heading
        Cesium.Math.toRadians(-40.0),  // pitch miring
        bs.radius * 2.5                // jarak kamera
      )
    });

    // tombol Home juga kembali ke area ini
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function (e) {
      e.cancel = true;
      viewer.camera.flyToBoundingSphere(bs, {
        duration: 1.2,
        offset: new Cesium.HeadingPitchRange(
          Cesium.Math.toRadians(-35.0),
          Cesium.Math.toRadians(-40.0),
          bs.radius * 2.5
        )
      });
    });

    statusEl.textContent = '3D Tiles ter-load. Memuat data 2D…';
  } catch (err) {
    console.error('Gagal memuat 3D Tiles:', err);
    statusEl.textContent = 'Gagal memuat 3D Tiles. Cek Asset ID 3D dan token.';
    return; // tanpa 3D, tidak usah lanjut
  }

  // 2) MUAT DATA 2D (JIKA ADA) – TAPI JANGAN GANGGU 3D
  try {
    dataSource2D = await Cesium.GeoJsonDataSource.fromIonAssetId(ASSET_ID_2D);
    viewer.dataSources.add(dataSource2D);

    const entities = dataSource2D.entities.values;
    for (let i = 0; i < entities.length; i++) {
      const e = entities[i];
      if (e.polygon) {
        e.polygon.material = Cesium.Color.fromCssColorString('#60a5fa').withAlpha(0.55);
        e.polygon.outline = true;
        e.polygon.outlineColor = Cesium.Color.fromCssColorString('#1d4ed8');
      }
      if (e.polyline) {
        e.polyline.width = 2.0;
        e.polyline.material = Cesium.Color.fromCssColorString('#2563eb');
      }
      if (e.point) {
        e.point.pixelSize = 7;
        e.point.color = Cesium.Color.fromCssColorString('#f97316');
        e.point.outlineColor = Cesium.Color.WHITE;
        e.point.outlineWidth = 1;
      }
    }

    statusEl.textContent = 'Data 3D & 2D siap. Silakan eksplor peta.';
  } catch (err) {
    console.warn('3D berhasil, tapi gagal memuat data 2D:', err);
    statusEl.textContent = '3D siap. Data 2D tidak berhasil dimuat (cek Asset ID 2D).';
  }
}



    // Tombol zoom manual
    btnZoomToData.addEventListener('click', function () {
      if (tileset3D) {
        const bs = tileset3D.boundingSphere;
        viewer.camera.flyToBoundingSphere(bs, {
          duration: 1.0,
          offset: new Cesium.HeadingPitchRange(
            Cesium.Math.toRadians(-35.0),
            Cesium.Math.toRadians(-40.0),
            bs.radius * 2.5
          )
        });
      } else if (dataSource2D) {
        viewer.flyTo(dataSource2D);
      }
    });

    // ===== 4. 2D / 3D =====
    btn3d.addEventListener('click', function () {
      viewer.scene.morphTo3D(1.0);
      setModeButton('3d');
    });

    btn2d.addEventListener('click', function () {
      viewer.scene.morphTo2D(1.0);
      setModeButton('2d');
    });

    // ===== 5. Waktu siang–malam =====
    function updateTimeFromSlider() {
      const hour = parseInt(timeSlider.value, 10);
      const now = Cesium.JulianDate.now();
      const gregorian = Cesium.JulianDate.toDate(now);
      gregorian.setUTCHours(hour, 0, 0, 0);
      const newTime = Cesium.JulianDate.fromDate(gregorian);
      viewer.clock.currentTime = newTime;
      viewer.clock.shouldAnimate = false;

      const hourStr = hour.toString().padStart(2, '0');
      timeDisplay.textContent = `Jam ${hourStr}:00 UTC`;
    }

    timeSlider.addEventListener('input', updateTimeFromSlider);
    updateTimeFromSlider();

    btnPlayTime.addEventListener('click', function () {
      viewer.clock.shouldAnimate = true;
      viewer.clock.multiplier = 4000;
      statusEl.textContent = 'Animasi waktu berjalan.';
    });

    btnPauseTime.addEventListener('click', function () {
      viewer.clock.shouldAnimate = false;
      statusEl.textContent = 'Animasi waktu dihentikan. Anda dapat geser slider jam.';
    });

    // ===== 6. Alat ukur jarak & luas =====
    let measureMode = null;
    let measurePositions = [];
    let measureShapeEntity = null;
    let measureLabelEntity = null;
    let measurePointEntities = [];

    function setMeasureMode(mode) {
      measureMode = mode;
      if (mode === 'distance') {
        measureLabelEl.textContent = 'Panjang';
        btnMeasureDistance.classList.add('active');
        btnMeasureArea.classList.remove('active');
        measureInfoEl.textContent = 'Mode panjang: klik di peta untuk membuat garis, klik kanan untuk selesai.';
      } else if (mode === 'area') {
        measureLabelEl.textContent = 'Luas';
        btnMeasureArea.classList.add('active');
        btnMeasureDistance.classList.remove('active');
        measureInfoEl.textContent = 'Mode luas: klik di peta untuk membuat poligon, klik kanan untuk selesai.';
      } else {
        measureLabelEl.textContent = 'Off';
        btnMeasureArea.classList.remove('active');
        btnMeasureDistance.classList.remove('active');
        measureInfoEl.textContent = 'Pilih mode, lalu klik di peta untuk menambah titik. Klik kanan untuk selesai.';
      }
    }

    function clearMeasurement() {
      measurePositions = [];
      if (measureShapeEntity) {
        viewer.entities.remove(measureShapeEntity);
        measureShapeEntity = null;
      }
      if (measureLabelEntity) {
        viewer.entities.remove(measureLabelEntity);
        measureLabelEntity = null;
      }
      for (const p of measurePointEntities) {
        viewer.entities.remove(p);
      }
      measurePointEntities = [];
      measureInfoEl.textContent = 'Pengukuran dibersihkan. Pilih mode untuk mulai lagi.';
    }

    btnMeasureDistance.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode('distance');
    });

    btnMeasureArea.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode('area');
    });

    btnMeasureClear.addEventListener('click', function () {
      clearMeasurement();
      setMeasureMode(null);
    });

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction(function (click) {
      if (!measureMode) return;

      let cartesian = viewer.scene.pickPosition(click.position);
      if (!Cesium.defined(cartesian)) {
        cartesian = viewer.camera.pickEllipsoid(
          click.position,
          viewer.scene.globe.ellipsoid
        );
      }
      if (!cartesian) return;

      measurePositions.push(cartesian);

      const point = viewer.entities.add({
        position: cartesian,
        point: {
          pixelSize: 7,
          color: Cesium.Color.LIME,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 1
        }
      });
      measurePointEntities.push(point);

      updateMeasurement();
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction(function () {
      if (!measureMode) return;
      measureInfoEl.textContent += '  (Pengukuran selesai, gunakan Clear untuk menghapus.)';
      measureMode = null;
      measureLabelEl.textContent = 'Off';
      btnMeasureArea.classList.remove('active');
      btnMeasureDistance.classList.remove('active');
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

    function updateMeasurement() {
      if (measureMode === 'distance' && measurePositions.length >= 2) {
        if (!measureShapeEntity) {
          measureShapeEntity = viewer.entities.add({
            polyline: {
              positions: measurePositions,
              width: 3,
              material: Cesium.Color.LIME
            }
          });
        }

        const ellipsoid = Cesium.Ellipsoid.WGS84;
        let total = 0.0;
        for (let i = 1; i < measurePositions.length; i++) {
          const c1 = ellipsoid.cartesianToCartographic(measurePositions[i - 1]);
          const c2 = ellipsoid.cartesianToCartographic(measurePositions[i]);
          const geodesic = new Cesium.EllipsoidGeodesic(c1, c2);
          total += geodesic.surfaceDistance;
        }

        const lastPos = measurePositions[measurePositions.length - 1];

        const km = total / 1000.0;
        const text = km >= 1
          ? `Panjang: ${km.toFixed(3)} km`
          : `Panjang: ${total.toFixed(1)} m`;

        if (!measureLabelEntity) {
          measureLabelEntity = viewer.entities.add({
            position: lastPos,
            label: {
              text: text,
              font: '14px sans-serif',
              fillColor: Cesium.Color.WHITE,
              outlineColor: Cesium.Color.BLACK,
              outlineWidth: 2,
              style: Cesium.LabelStyle.FILL_AND_OUTLINE,
              verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
              pixelOffset: new Cesium.Cartesian2(0, -10)
            }
          });
        } else {
          measureLabelEntity.position = lastPos;
          measureLabelEntity.label.text = text;
        }

        measureInfoEl.textContent = text;
      }

      if (measureMode === 'area' && measurePositions.length >= 3) {
        if (!measureShapeEntity) {
          measureShapeEntity = viewer.entities.add({
            polygon: {
              hierarchy: new Cesium.CallbackProperty(function () {
                return new Cesium.PolygonHierarchy(measurePositions);
              }, false),
              material: Cesium.Color.LIME.withAlpha(0.3),
              outline: true,
              outlineColor: Cesium.Color.LIME
            }
          });
        }

        const R = 6378137.0;
        const cartos = measurePositions.map(p => Cesium.Cartographic.fromCartesian(p));
        const lat0 = cartos[0].latitude;
        const cosLat0 = Math.cos(lat0);

        const xy = cartos.map(c => {
          const x = R * c.longitude * cosLat0;
          const y = R * c.latitude * R / R;
          return { x, y };
        });

        let area = 0.0;
        for (let i = 0; i < xy.length; i++) {
          const j = (i + 1) % xy.length;
          area += xy[i].x * xy[j].y - xy[j].x * xy[i].y;
        }
        area = Math.abs(area) * 0.5;

        const ha = area / 10000.0;
        const km2 = area / 1e6;
        let text;
        if (km2 >= 1) {
          text = `Luas: ${km2.toFixed(3)} km²`;
        } else if (ha >= 1) {
          text = `Luas: ${ha.toFixed(2)} ha`;
        } else {
          text = `Luas: ${area.toFixed(1)} m²`;
        }

        let sumX = 0, sumY = 0, sumZ = 0;
        for (const p of measurePositions) {
          sumX += p.x; sumY += p.y; sumZ += p.z;
        }
        const center = new Cesium.Cartesian3(
          sumX / measurePositions.length,
          sumY / measurePositions.length,
          sumZ / measurePositions.length
        );

        if (!measureLabelEntity) {
          measureLabelEntity = viewer.entities.add({
            position: center,
            label: {
              text: text,
              font: '14px sans-serif',
              fillColor: Cesium.Color.WHITE,
              outlineColor: Cesium.Color.BLACK,
              outlineWidth: 2,
              style: Cesium.LabelStyle.FILL_AND_OUTLINE,
              verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
              pixelOffset: new Cesium.Cartesian2(0, -10)
            }
          });
        } else {
          measureLabelEntity.position = center;
          measureLabelEntity.label.text = text;
        }

        measureInfoEl.textContent = text;
      }
    }
  </script>
</body>
</html>


