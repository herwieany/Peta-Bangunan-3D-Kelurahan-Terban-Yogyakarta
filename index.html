<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peta Bangunan Kelurahan Terban, Yogyakarta</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Toolbar Menu Styles */
    #toolbar {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(30, 30, 30, 0.9);
      padding: 15px;
      border-radius: 8px;
      color: white;
      z-index: 100;
      width: 220px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    
    h1 {
      font-size: 16px;
      margin: 0 0 15px 0;
      color: #61dafb;
      text-align: center;
      border-bottom: 1px solid #555;
      padding-bottom: 10px;
    }

    .group-label {
        font-size: 12px;
        color: #aaa;
        margin-top: 10px;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    button {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      background: #444;
      color: white;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    button:hover { background: #666; border-color: #888; }
    button.active { background: #0078d4; border-color: #0078d4; font-weight: bold; }
    
    /* Grid layout untuk tombol 2D/3D agar bersebelahan */
    .view-controls {
        display: flex;
        gap: 5px;
    }
    .view-controls button {
        width: 50%;
    }

    #info {
      font-size: 11px;
      color: #ddd;
      margin-top: 10px;
      background: #222;
      padding: 5px;
      border-radius: 4px;
      display: none; /* Hidden by default */
    }
  </style>
</head>
<body>

  <div id="cesiumContainer"></div>

  <div id="toolbar">
    <h1>Peta Terban</h1>
    
    <div class="group-label">Mode Tampilan</div>
    <div class="view-controls">
        <button id="btn3D" class="active" onclick="switchView('3D')">3D View</button>
        <button id="btn2D" onclick="switchView('2D')">2D Map</button>
    </div>

    <div class="group-label">Alat Ukur</div>
    <button id="btnDistance" onclick="toggleMode('distance')">üìè Ukur Jarak</button>
    <button id="btnArea" onclick="toggleMode('area')">üìê Ukur Luas</button>
    <button onclick="clearMeasurements()" style="background:#8b0000;">üóëÔ∏è Reset Ukuran</button>
    
    <div id="info"></div>
  </div>

  <script>
    // --- 1. SETUP TOKEN & DATA ---
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwNTY2Y2Y1Ni02YWUyLTQ1OWQtODcyYi1lZGM5OTJhOWI1OWQiLCJpZCI6MjEzNjk3LCJpYXQiOjE3NjU4NjA2NzF9.37HTp-nTHxNr4umeQruV45iHJnaxmJsS94B_yUIdm28';

    // Inisialisasi Viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(), // Menggunakan ID=1 (Default Terrain)
      animation: false, 
      timeline: false,
      infoBox: false,
      sceneModePicker: false, // Kita matikan defaultnya, ganti dengan tombol kustom kita
      baseLayerPicker: true,
      geocoder: false,
      homeButton: false
    });

    // Mengaktifkan Lighting (Matahari)
    viewer.scene.globe.enableLighting = true;

    // --- MEMUAT DATA 3D (ASSET ID) ---
    // Jika Anda punya Asset ID sendiri (misal data drone Terban), ganti ID di bawah:
    const myCustomAssetId = 4224210; 
    
  // --- LOAD DATA CUSTOM (DATA DRONE/3D SENDIRI) ---
    async function loadCustomAsset() {
      try {
        // PENTING: Ganti 123456 di bawah dengan Asset ID asli Anda dari Cesium Ion
        // Pastikan ditulis sebagai angka (tanpa tanda kutip)
        const resource = await Cesium.IonResource.fromAssetId(123456);
        
        const myTileset = await Cesium.Cesium3DTileset.fromUrl(resource);
        viewer.scene.primitives.add(myTileset);

        // Opsional: Otomatis Zoom kamera ke lokasi aset tersebut
        // (Sangat berguna jika koordinat aset Anda agak geser dari titik default)
        viewer.zoomTo(myTileset);
        
      } catch (error) {
        console.error("Gagal memuat aset:", error);
        alert("Gagal memuat Asset ID. Cek console browser.");
      }
    }

    // Jalankan fungsi
    loadCustomAsset();
    
    /* JIKA INGIN LOAD DATA SENDIRI, GUNAKAN KODE INI:
       async function loadMyData() {
           try {
               const resource = await Cesium.IonResource.fromAssetId(YOUR_ASSET_ID_HERE);
               const tileset = await Cesium.Cesium3DTileset.fromUrl(resource);
               viewer.scene.primitives.add(tileset);
               viewer.zoomTo(tileset);
           } catch (error) {
               console.log(error);
           }
       }
       loadMyData();
    */

    // --- 2. POSISI KAMERA (Kelurahan Terban) ---
    const terbanLocation = Cesium.Cartesian3.fromDegrees(110.3755, -7.7835, 600);
    
    viewer.camera.flyTo({
      destination: terbanLocation,
      orientation: {
        heading: Cesium.Math.toRadians(0.0),
        pitch: Cesium.Math.toRadians(-35.0),
        roll: 0.0
      }
    });

    // --- 3. FUNGSI GANTI MODE 2D / 3D ---
    function switchView(mode) {
        // Update UI Button
        document.getElementById('btn3D').classList.remove('active');
        document.getElementById('btn2D').classList.remove('active');
        
        if (mode === '3D') {
            viewer.scene.morphTo3D(); // Fungsi API Cesium untuk ke 3D
            document.getElementById('btn3D').classList.add('active');
        } else {
            viewer.scene.morphTo2D(); // Fungsi API Cesium untuk ke 2D (Peta Datar)
            document.getElementById('btn2D').classList.add('active');
        }
    }

    // --- 4. LOGIKA ALAT UKUR (Sama seperti sebelumnya, disempurnakan) ---
    const scene = viewer.scene;
    let activeMode = null; 
    let activeShapePoints = [];
    let activeShape;
    let floatingPoint;
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    const infoDiv = document.getElementById('info');

    function toggleMode(mode) {
      clearMeasurements(); // Reset dulu sebelum ganti
      activeMode = mode;
      
      document.getElementById('btnDistance').classList.remove('active');
      document.getElementById('btnArea').classList.remove('active');
      
      if(mode) {
        document.getElementById(mode === 'distance' ? 'btnDistance' : 'btnArea').classList.add('active');
        infoDiv.style.display = 'block';
        infoDiv.innerText = "Klik Kiri: Tambah Titik. Klik Kanan: Selesai.";
      } else {
        infoDiv.style.display = 'none';
      }
    }

    function createPoint(worldPosition) {
      return viewer.entities.add({
        position: worldPosition,
        point: { color: Cesium.Color.YELLOW, pixelSize: 10, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }
      });
    }

    function drawShape(positionData) {
      if (activeMode === 'distance') {
        return viewer.entities.add({
          polyline: { positions: positionData, width: 3, material: Cesium.Color.CYAN, clampToGround: true }
        });
      } else if (activeMode === 'area') {
        return viewer.entities.add({
          polygon: { hierarchy: positionData, material: new Cesium.ColorMaterialProperty(Cesium.Color.CYAN.withAlpha(0.5)), clampToGround: true }
        });
      }
    }

    handler.setInputAction(function (event) {
      if (!activeMode) return;
      let earthPosition = scene.pickPosition(event.position);
      if (Cesium.defined(earthPosition)) {
        if (activeShapePoints.length === 0) {
          floatingPoint = createPoint(earthPosition);
          activeShapePoints.push(earthPosition);
          const dynamicPositions = new Cesium.CallbackProperty(function () {
             return activeMode === 'area' ? new Cesium.PolygonHierarchy(activeShapePoints) : activeShapePoints;
          }, false);
          activeShape = drawShape(dynamicPositions);
        }
        activeShapePoints.push(earthPosition);
        createPoint(earthPosition);
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction(function (event) {
      if (Cesium.defined(floatingPoint)) {
        const newPosition = scene.pickPosition(event.endPosition);
        if (Cesium.defined(newPosition)) {
          floatingPoint.position.setValue(newPosition);
          activeShapePoints.pop();
          activeShapePoints.push(newPosition);
        }
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    handler.setInputAction(function (event) {
      if (!activeMode) return;
      activeShapePoints.pop(); 
      calculateResult();
      terminateShape(); 
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

    function terminateShape() {
      activeShapePoints = [];
      activeShape = undefined;
      floatingPoint = undefined;
      activeMode = null;
      document.getElementById('btnDistance').classList.remove('active');
      document.getElementById('btnArea').classList.remove('active');
      infoDiv.innerText = "Selesai.";
    }

    function clearMeasurements() {
      viewer.entities.removeAll();
      terminateShape();
      infoDiv.style.display = 'none';
    }

    function calculateResult() {
        const entityList = viewer.entities.values;
        const points = [];
        entityList.forEach(e => { if(e.point) points.push(e.position.getValue(Cesium.JulianDate.now())); });
        
        if (points.length < 2) return;
        
        if (entityList.find(e => e.polyline)) {
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) totalDistance += Cesium.Cartesian3.distance(points[i], points[i+1]);
            alert(`Jarak Total: ${totalDistance.toFixed(2)} meter`);
        } else if (entityList.find(e => e.polygon)) {
            alert("Area Polygon Terbentuk (Perhitungan luas akurat memerlukan library geodesi tambahan)");
        }
    }
  </script>
</body>
</html>
